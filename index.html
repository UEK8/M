<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet"/>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <style>
    :root{
      --primary:#2563eb;
      --secondary:#f0f4ff;
      --background:#fafafa;
      --text:#222;
      --bot-bubble:#f1f3f4;
      --radius:12px;
      --shadow:0 6px 18px rgba(0,0,0,.08);
      --fs:16px;
    }
    body.dark{
      --primary:#3b82f6;
      --secondary:#1e293b;
      --background:#0f172a;
      --text:#e2e8f0;
      --bot-bubble:#1e293b;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Tajawal',sans-serif;
      background:var(--background);
      color:var(--text);
      display:flex;flex-direction:column;
      transition:background .3s,color .3s;
      font-size:var(--fs);
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes shine {
      0% { transform: rotate(30deg) translate(-30%, -30%); }
      100% { transform: rotate(30deg) translate(30%, 30%); }
    }

    /* Top bar */
    .top-bar{
      position:fixed;top:0;left:0;right:0;
      background:#fff;border-bottom:1px solid #eee;
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 14px;z-index:100;
      transition:background .3s,border-color .3s;
      animation: fadeIn 0.5s ease-out;
    }
    body.dark .top-bar{background:#1e293b;border-color:#334155}
    .brand{display:flex;align-items:center;gap:10px;color:var(--primary);font-weight:700}
    .logo{width:50px;height:50px;border-radius:8px; animation: pulse 2s infinite}
    .user-pill{display:flex;align-items:center;gap:8px;background:var(--secondary);color:var(--primary);padding:6px 10px;border-radius:999px}
    .user-pill img {width:30px;height:30px;border-radius:50%;margin-left:8px}

    /* Side nav */
    nav{
      position:fixed;top:0;right:-260px;height:100%;width:240px;
      background:#fff;border-left:1px solid #eee;padding:80px 14px 18px;
      transition:right .35s, background .3s, border-color .3s; z-index:200;
    }
    body.dark nav{background:#1e293b;border-color:#334155}
    nav.active{right:0}
    
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    .user-profile-sidebar {
      text-align: center;
      padding: 20px 0;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    #sidebar-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 10px;
      overflow: hidden;
      background: #f1f3f4;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #sidebar-avatar-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    #sidebar-username {
      font-weight: 600;
      color: var(--primary);
    }
    
    body.dark .user-profile-sidebar {
      border-color: #334155;
    }
    
    body.dark #sidebar-avatar {
      background: #334155;
    }
    
    nav a{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:10px;margin:6px 0;
      color:#333;text-decoration:none;font-weight:500;transition:.25s;
    }
    body.dark nav a{color:#e2e8f0}
    nav a:hover,nav a.active{background:var(--secondary);color:var(--primary); animation: pulse 0.5s}
    .menu-btn,.theme-btn{
      background:transparent;border:none;cursor:pointer;font-size:1.2rem;color:inherit;
      transition: transform 0.3s;
    }
    .menu-btn:hover,.theme-btn:hover{transform: rotate(15deg)}

    /* Main / Views */
    .main{margin-top:60px;display:flex;min-height:calc(100vh - 60px)}
    .view{display:none;flex:1; animation: fadeIn 0.3s ease-out}
    .view.active{display:block}
    .container{padding:16px}
    .card{
      background:#fff;border:1px solid #eee;border-radius:14px;padding:16px;margin-bottom:12px;box-shadow:var(--shadow);
      transition:background .3s,border-color .3s; animation: fadeIn 0.4s ease-out
    }
    body.dark .card{background:#0b1222;border-color:#1b2740}
    .section-title{font-weight:700;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1 1 220px}

    /* Inputs & Buttons */
    input[type="text"],input[type="email"],input[type="password"],textarea,select{
      width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fff;color:#111;
      transition:background .3s,border-color .3s,color .3s
    }
    body.dark input,body.dark textarea,body.dark select{background:#0b1222;border-color:#1b2740;color:#e2e8f0}
    textarea{min-height:90px;resize:vertical}
    .btn{
      background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 12px;cursor:pointer;
      transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn:hover{transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15)}
    .btn.secondary{background:#e5e7eb;color:#111}
    .btn.ghost{background:transparent;border:1px solid #e5e7eb;color:inherit}
    body.dark .btn.secondary{background:#334155;color:#e2e8f0}
    .btn.danger{background:#ef4444}
    .muted{opacity:.75}

    /* New Button Styles */
    .btn-gradient {
      background: linear-gradient(45deg, var(--primary), #a855f7);
      color: white !important;
      border: none !important;
    }
    .btn-3d {
      box-shadow: 0 4px 0 #1e40af, 0 6px 8px rgba(0,0,0,0.2);
      transform: translateY(0);
      transition: all 0.2s;
    }
    .btn-3d:active {
      transform: translateY(4px);
      box-shadow: 0 1px 0 #1e40af;
    }
    .btn-special {
      position: relative;
      overflow: hidden;
    }
    .btn-special::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        to bottom right,
        rgba(255,255,255,0.3),
        rgba(255,255,255,0)
      );
      transform: rotate(30deg);
      animation: shine 3s infinite;
    }
    .btn-float {
      animation: float 3s ease-in-out infinite;
    }
    .btn-shake:hover {
      animation: shake 0.5s;
    }

    /* Chat */
    .chat-container{height:calc(100vh - 60px - 64px);padding:15px;overflow-y:auto}
    .message{display:flex;margin:10px 0;align-items:flex-end; animation: fadeIn 0.3s ease-out}
    .message.user{justify-content:flex-start}
    .message.bot{justify-content:flex-end}
    .bubble{
      padding:10px 14px;border-radius:12px;max-width:75%;
      font-size:.95rem;line-height:1.5;transition:background .3s,color .3s;
      box-shadow:var(--shadow)
    }
    .message.user .bubble{background:var(--primary);color:#fff;border-bottom-right-radius:4px}
    .message.bot .bubble{background:var(--bot-bubble);color:var(--text);border-bottom-left-radius:4px}
    .typing{display:flex;gap:4px;align-items:center;padding:10px 14px;background:var(--bot-bubble);border-radius:12px;box-shadow:var(--shadow)}
    .dot{width:6px;height:6px;border-radius:50%;background:var(--text);animation:blink 1.4s infinite both}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.3;transform:translateY(0)}40%{opacity:1;transform:translateY(-3px)}}

    .bottom-bar{
      position:fixed;bottom:0;left:0;right:0;
      background:#fff;border-top:1px solid #eee;display:flex;gap:10px;padding:10px;
      transition:background .3s,border-color .3s
    }
    body.dark .bottom-bar{background:#1e293b;border-color:#334155}
    .input-wrap{flex:1;background:#f1f3f4;border-radius:12px;display:flex;align-items:center;padding:0 10px}
    body.dark .input-wrap{background:#334155}
    .bottom-bar input{flex:1;background:transparent;border:none;padding:10px;color:inherit;font-family:'Tajawal',sans-serif}
    .bottom-bar input:focus{outline:none}

    /* Projects */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .project-card .tag{display:inline-block;background:var(--secondary);color:var(--primary);padding:2px 8px;border-radius:999px;margin:2px 4px 0 0;font-size:.8rem}

    /* Settings */
    .toggle{display:flex;align-items:center;gap:8px}
    .color-dot{width:22px;height:22px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.1);cursor:pointer; transition: transform 0.3s}
    .color-dot:hover{transform: scale(1.2)}
    .row.cols-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}

    /* Progress Bar */
    .progress-bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin: 12px 0;
    }
    .progress-fill {
      height: 100%;
      background: var(--primary);
      width: 0;
      transition: width 0.5s ease;
      border-radius: 3px;
    }

    /* Icons */
    .icon-spin {
      animation: spin 2s linear infinite;
    }
    .icon-pulse {
      animation: pulse 1.5s infinite;
    }
    .icon-float {
      animation: float 3s ease-in-out infinite;
    }

    .space{height:8px}
    .hidden{display:none}
    
    /* Model Selector */
    .model-selector {
      position: fixed;
      bottom: 70px;
      left: 10px;
      right: 10px;
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
      z-index: 90;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      transition: all 0.3s;
    }
    body.dark .model-selector {
      background: #1e293b;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
    }
    .model-btn {
      padding: 8px 12px;
      border-radius: 8px;
      background: #f1f3f4;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s;
      flex: 1;
      min-width: 100px;
    }
    body.dark .model-btn {
      background: #334155;
      color: #e2e8f0;
    }
    .model-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .model-btn:hover {
      transform: translateY(-2px);
    }
    .toggle-models {
      position: fixed;
      bottom: 1px;
      right: 1px;
      width: 1px;
      height: 1px;
      border-radius: 1%;
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      z-index: 95;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© */
    .profile-upload {
      text-align: center;
      margin: 10px 0;
    }

    .upload-label {
      display: inline-block;
      padding: 10px 15px;
      background: var(--secondary);
      color: var(--primary);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .upload-label:hover {
      background: var(--primary);
      color: white;
    }

    .avatar-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 10px auto;
      background: #f1f3f4;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    body.dark .avatar-preview {
      background: #334155;
    }
    
    /* Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ù‡Ø¨ÙˆØ· Ø§Ù„ØµÙØ­Ø© ÙÙŠ ÙƒØ±ÙˆÙ… Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© */
    @media screen and (max-width: 768px) {
      .chat-container {
        -webkit-overflow-scrolling: touch;
        overflow-anchor: none;
      }
      
      .bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
      }
      
      body {
        height: 100vh;
        height: -webkit-fill-available;
      }
      
      html {
        height: -webkit-fill-available;
      }
    }

    /* Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠ iOS */
    input, textarea {
      font-size: 16px !important;
    }

    @media screen and (max-width: 480px) {
      input, textarea, select {
        font-size: 16px !important;
        max-height: 44px; /* Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø± ÙÙŠ iOS */
      }
    }
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="top-bar">
    <div class="brand">
      <img class="logo" src="https://i.supaimg.com/88e6bc23-41ac-4443-a144-631a191daa13.png" alt="logo"/>
      <span></span>
    </div>
    <div class="user-pill" id="user-pill" style="display:none">
      <i class="fas fa-user"></i> <span id="user-name-pill"></span>
    </div>
    <div>
      <button class="theme-btn" id="theme-btn" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†"><i class="fas fa-moon"></i></button>
      <button class="menu-btn" id="menu-btn" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"><i class="fas fa-bars"></i></button>
    </div>
  </div>

  <!-- Side Nav -->
  <nav id="sidenav">
    <div class="user-profile-sidebar">
      <div id="sidebar-avatar">
        <img src="https://via.placeholder.com/80?text=Ø¶ÙŠÙ" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„" id="sidebar-avatar-img">
      </div>
      <div id="sidebar-username">Ø¶ÙŠÙ</div>
    </div>
    
    <a href="#chat" data-view="chat" class="active"><i class="fas fa-comments"></i> Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</a>
    <a href="#projects" data-view="projects"><i class="fas fa-folder-plus"></i> Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</a>
    <a href="#settings" data-view="settings"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    <a href="#signup" data-view="signup"><i class="fas fa-user"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
    <div style="margin-top:20px; font-size:12px; text-align:center; opacity:0.6;">
      Developer: Mostapha Hachmi
    </div>
  </nav>

  <!-- Main -->
  <div class="main">

    <!-- Chat View -->
    <section id="view-chat" class="view active">
      <div class="chat-container" id="chat-content">
        <div class="message user"><div class="bubble">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div></div>
        <div class="message bot"><div class="bubble">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! ÙƒÙŠÙ Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯ÙƒØŸ</div></div>
      </div>
      <button class="toggle-models" id="toggle-models" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬">
        <i class="fas fa-robot"></i>
      </button>
      <div class="model-selector" id="model-selector" style="display: none;">
        <button class="model-btn active" data-model="HOMELESS">HOMELESS</button>
        <button class="model-btn" data-model="gemini5">Gemini 5</button>
      </div>
      <form class="bottom-bar" id="chat-form">
        <div class="input-wrap">
          <input type="text" id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off">
        </div>
        <button type="submit" class="btn btn-gradient"><i class="fas fa-paper-plane"></i></button>
      </form>
    </section>

    <!-- Projects View -->
    <section id="view-projects" class="view">
      <div class="container">
        <div class="card">
          <div class="section-title"><i class="fas fa-folder-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹</div>
          <div class="row">
            <div>
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
              <input type="text" id="proj-name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ù…ØªØ¬Ø±">
            </div>
            <div>
              <label>ÙˆØ³ÙˆÙ… (Ø§ÙØµÙ„Ù‡Ø§ Ø¨ÙÙˆØ§ØµÙ„)</label>
              <input type="text" id="proj-tags" placeholder="Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ, Ù…ØªØ¬Ø±, Ø¯Ø¹Ù…">
            </div>
          </div>
          <div class="space"></div>
          <div>
            <label>ÙˆØµÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
            <textarea id="proj-desc" placeholder="ØµÙ ÙÙƒØ±ØªÙƒ Ø£Ùˆ Ø§Ù„Ù‡Ø¯Ù Ù…Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"></textarea>
          </div>
          <div class="space"></div>
          <div class="row">
            <button class="btn btn-3d" id="btn-create"><i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡</button>
            <button class="btn secondary btn-shake" id="btn-clear-form" type="button"><i class="fas fa-broom"></i> Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          </div>
        </div>

        <div class="card">
          <div class="section-title"><i class="fas fa-box"></i> Ù…Ø´Ø§Ø±ÙŠØ¹ÙŠ</div>
          <div class="space"></div>
          <div id="projects-list" class="grid"></div>
          <div class="row">
            <button class="btn danger" id="btn-clear-all" type="button"><i class="fas fa-trash"></i> Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
            <button class="btn ghost" id="btn-new-project" type="button"><i class="fas fa-plus"></i> Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Settings View -->
    <section id="view-settings" class="view">
      <div class="container">
        <div class="card">
          <div class="section-title"><i class="fas fa-chart-bar icon-float"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
          <div class="row" style="gap: 12px;">
            <div class="card" style="flex: 1; text-align: center;">
              <div style="font-size: 2rem; color: var(--primary);">0</div>
              <div>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</div>
            </div>
            <div class="card" style="flex: 1; text-align: center;">
              <div style="font-size: 2rem; color: #22c55e;">00:00</div>
              <div>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: 0%"></div>
          </div>
        </div>

        <div class="card">
          <div class="section-title"><i class="fas fa-sliders"></i> Ø§Ù„Ù…Ø¸Ù‡Ø±</div>
          <div class="row">
            <div class="toggle">
              <input type="checkbox" id="set-dark"/>
              <label for="set-dark">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</label>
            </div>
          </div>
          <div class="space"></div>
          <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
          <div class="row cols-3">
            <div class="color-dot" data-color="#2563eb" style="background:#2563eb"></div>
            <div class="color-dot" data-color="#22c55e" style="background:#22c55e"></div>
            <div class="color-dot" data-color="#ef4444" style="background:#ef4444"></div>
            <div class="color-dot" data-color="#a855f7" style="background:#a855f7"></div>
            <div class="color-dot" data-color="#f59e0b" style="background:#f59e0b"></div>
            <div class="color-dot" data-color="#06b6d4" style="background:#06b6d4"></div>
          </div>
        </div>

        <div class="card">
          <div class="section-title"><i class="fas fa-text-height"></i> Ø§Ù„Ø®Ø·</div>
          <div class="row">
            <div>
              <label>Ø­Ø¬Ù… Ø§Ù„Ø£Ø³Ø§Ø³</label>
              <select id="set-font">
                <option value="14px">ØµØºÙŠØ±</option>
                <option value="16px" selected>Ø¹Ø§Ø¯ÙŠ</option>
                <option value="18px">ÙƒØ¨ÙŠØ±</option>
                <option value="20px">ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="section-title"><i class="fas fa-language"></i> Ø§Ù„Ù„ØºØ©</div>
          <div class="row">
            <div>
              <label>Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</label>
              <select id="set-lang">
                <option value="ar" selected>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                <option value="en">English</option>
                <option value="fr">FranÃ§ais</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="section-title"><i class="fas fa-icons icon-spin"></i> Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª</div>
          <div class="row cols-3" style="gap: 8px; margin-top: 12px;">
            <button class="btn"><i class="fas fa-rocket"></i> Ø¥Ø·Ù„Ø§Ù‚</button>
            <button class="btn btn-gradient"><i class="fas fa-magic"></i> Ø³Ø­Ø±</button>
            <button class="btn btn-3d"><i class="fas fa-gamepad"></i> Ù„Ø¹Ø¨Ø©</button>
            <button class="btn btn-special"><i class="fas fa-star icon-spin"></i> Ù…Ù…ÙŠØ²</button>
            <button class="btn btn-float"><i class="fas fa-cloud"></i> Ø³Ø­Ø§Ø¨Ø©</button>
            <button class="btn"><i class="fas fa-robot"></i> Ø±ÙˆØ¨ÙˆØª</button>
          </div>
        </div>

        <div class="card">
          <div class="section-title"><i class="fas fa-user-shield"></i> Ø§Ù„Ø­Ø³Ø§Ø¨</div>
          <div id="account-info" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„</div>
          <div class="space"></div>
          <div class="row">
            <button class="btn secondary" id="btn-go-signup" type="button"><i class="fas fa-user-plus"></i> Ø¥Ù„Ù‰ ØµÙØ­Ø© Sign-up</button>
            <button class="btn danger hidden" id="btn-logout" type="button"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>

        <div class="card">
          <div class="section-title"><i class="fas fa-database"></i> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
          <div class="row">
            <button class="btn danger" id="btn-reset-settings" type="button"><i class="fas fa-trash-restore"></i> Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button class="btn danger" id="btn-reset-users" type="button"><i class="fas fa-user-times"></i> Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Signup/Login View -->
    <section id="view-signup" class="view">
      <div class="container">
        <div class="card" id="signup-card">
          <div class="section-title"><i class="fas fa-user-plus icon-pulse"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ +</div>
          <input type="text" id="reg-name" placeholder="Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…"><br><br>
          <input type="text" id="reg-username" placeholder="ÙŠÙˆØ²Ø± Ù…Ø³ØªØ®Ø¯Ù…"><br><br>
          <input type="email" id="reg-email" placeholder="exemple@gmail.com"><br><br>
          <input type="password" id="reg-pass" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø±"><br><br>
          
          <!-- Ø­Ù‚Ù„ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ -->
          <div class="profile-upload">
            <label for="reg-avatar" class="upload-label">
              <i class="fas fa-cloud-upload-alt"></i> Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ğŸ’¬
            </label>
            <input type="file" id="reg-avatar" accept="image/*" style="display: none;">
            <div id="avatar-preview" class="avatar-preview"></div>
          </div>
          <br>
          
          <button class="btn btn-gradient btn-3d" id="btn-register"><i class="fas fa-user-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
          <div class="link" id="to-login" style="margin-top:10px;color:var(--primary);cursor:pointer">Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ØŸ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</div>
        </div>
        <div class="card" id="login-card" style="display:none">
          <div class="section-title"><i class="fas fa-sign-in-alt icon-pulse"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
          <input type="email" id="log-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"><br><br>
          <input type="password" id="log-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><br><br>
          <button class="btn btn-gradient" id="btn-login"><i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„</button>
          <div class="link" id="to-register" style="margin-top:10px;color:var(--primary);cursor:pointer">Ù„Ø§ Ø£Ù…Ù„Ùƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</div>
        </div>
      </div>
    </section>

  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAQFa9Xt-WSD3tKsksEyyAlDNBcwORZLYc",
      authDomain: "mostafa-82878.firebaseapp.com",
      projectId: "mostafa-82878",
      storageBucket: "mostafa-82878.appspot.com",
      messagingSenderId: "269958161580",
      appId: "1:269958161580:web:b846d49578fb2068e6eb09",
      measurementId: "G-VPEVY74FNF"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // DOM Helpers
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const nav = $('#sidenav');
    const body = document.body;

    // API Configuration
    const API_MODELS = {
      "HOMELESS": "https://api4dev.ir/ai/?text=",
      "gemini5": "https://api.x7m.site/apis/v2/GPT-5_mini.php?text="
    };

    // Storage keys
    const STORAGE_SETTINGS = 'chatSettings:v1';
    const STORAGE_PROJECTS = 'projects:v1';
    const STORAGE_CURRENT_USER = 'currentUser:v1';
    const STORAGE_SELECTED_MODEL = 'selectedModel:v1';

    // Global state
    const state = {
      settings: { dark: false, primary: '#2563eb', lang: 'ar', fontSize: '16px' },
      projects: [],
      currentUser: null,
      selectedModel: 'HOMELESS'
    };

    // Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØµÙØ­ ÙÙŠ Chrome
    if (/Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor)) {
      document.addEventListener('DOMContentLoaded', function() {
        // Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªØ®Ø·ÙŠØ· ÙÙŠ Chrome
        setTimeout(function() {
          document.body.style.zoom = "100%";
          if (document.documentElement.scrollHeight <= document.documentElement.clientHeight) {
            document.body.style.height = '100vh';
          }
        }, 100);
      });
      
      // Ù…Ù†Ø¹ Ø³Ù„ÙˆÙƒ Ø§Ù„Ø²ÙˆÙ… ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨ ÙÙŠÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
      document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });
      
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(e) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, { passive: false });
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      loadState();
      setupEventListeners();
      updateClock();
      setInterval(updateClock, 60000);
      
      // Listen for auth state changes
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          const userDoc = await db.collection('users').doc(user.uid).get();
          if (userDoc.exists) {
            state.currentUser = {
              uid: user.uid,
              name: userDoc.data().name,
              username: userDoc.data().username,
              email: user.email,
              avatar: userDoc.data().avatar || ''
            };
            saveCurrentUser();
            refreshAuthUI();
          }
        } else {
          state.currentUser = null;
          saveCurrentUser();
          refreshAuthUI();
        }
      });
    });

    function updateClock() {
      const now = new Date();
      const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      const timeElement = $('#view-settings .card:nth-child(1) .card:nth-child(2) div:first-child');
      if (timeElement) timeElement.textContent = timeStr;
    }

    function loadState() {
      try {
        const s = JSON.parse(localStorage.getItem(STORAGE_SETTINGS));
        if (s) Object.assign(state.settings, s);
        const p = JSON.parse(localStorage.getItem(STORAGE_PROJECTS));
        if (p) state.projects = p;
        const cu = JSON.parse(localStorage.getItem(STORAGE_CURRENT_USER));
        if (cu) state.currentUser = cu;
        const sm = localStorage.getItem(STORAGE_SELECTED_MODEL);
        if (sm) state.selectedModel = sm;
      } catch (e) {
        console.error('Error loading state:', e);
      }
      applySettingsToDOM();
      refreshAuthUI();
      renderProjects();
      loadAdditionalIcons();
      updateSelectedModelUI();
    }

    function setupEventListeners() {
      // Navigation
      $('#menu-btn').addEventListener('click', () => {
        nav.classList.toggle('active');
        $('#menu-btn i').classList.toggle('fa-bars');
        $('#menu-btn i').classList.toggle('fa-times');
      });
      
      nav.addEventListener('click', e => {
        const a = e.target.closest('a[data-view]'); if (!a) return;
        e.preventDefault();
        switchView(a.dataset.view);
        $$('#sidenav a').forEach(el => el.classList.toggle('active', el === a));
        nav.classList.remove('active');
        $('#menu-btn i').classList.add('fa-bars');
        $('#menu-btn i').classList.remove('fa-times');
      });

      // Chat
      $('#chat-form').addEventListener('submit', handleChatSubmit);
      
      // Model selector
      $('#toggle-models').addEventListener('click', () => {
        const selector = $('#model-selector');
        selector.style.display = selector.style.display === 'none' ? 'flex' : 'none';
      });
      
      $$('.model-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const model = e.target.dataset.model;
          state.selectedModel = model;
          localStorage.setItem(STORAGE_SELECTED_MODEL, model);
          updateSelectedModelUI();
          
          // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
          $('#model-selector').style.display = 'none';
        });
      });

      // Projects
      $('#btn-create').addEventListener('click', createProject);
      $('#btn-clear-form').addEventListener('click', clearProjectForm);
      $('#btn-new-project').addEventListener('click', () => { switchView('projects'); window.scrollTo(0, 0); });
      $('#projects-list').addEventListener('click', handleProjectActions);
      $('#btn-clear-all').addEventListener('click', clearAllProjects);

      // Settings
      $('#set-dark').addEventListener('change', toggleDarkMode);
      $('#set-lang').addEventListener('change', changeLanguage);
      $('#set-font').addEventListener('change', changeFontSize);
      $$('.color-dot').forEach(el => {
        el.addEventListener('click', () => changePrimaryColor(el.dataset.color));
      });
      $('#btn-go-signup').addEventListener('click', () => { switchView('signup'); });
      $('#btn-reset-settings').addEventListener('click', resetSettings);
      $('#btn-reset-users').addEventListener('click', resetUsers);

      // Auth
      $('#btn-logout').addEventListener('click', logout);
      $('#to-login').addEventListener('click', () => {
        $('#signup-card').style.display = 'none';
        $('#login-card').style.display = 'block';
      });
      $('#to-register').addEventListener('click', () => {
        $('#login-card').style.display = 'none';
        $('#signup-card').style.display = 'block';
      });
      $('#btn-register').addEventListener('click', register);
      $('#btn-login').addEventListener('click', login);
      
      // Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹
      $('#reg-avatar').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = $('#avatar-preview');
            preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
          }
          reader.readAsDataURL(file);
        }
      });
    }

    function updateSelectedModelUI() {
      $$('.model-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.model === state.selectedModel);
      });
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    function updateSidebarProfile() {
      const avatarImg = $('#sidebar-avatar-img');
      const usernameEl = $('#sidebar-username');
      
      if (state.currentUser) {
        if (state.currentUser.avatar) {
          avatarImg.src = state.currentUser.avatar;
        } else {
          avatarImg.src = "https://via.placeholder.com/80?text=ØµÙˆØ±Ø©";
        }
        usernameEl.textContent = state.currentUser.name || state.currentUser.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
      } else {
        avatarImg.src = "https://via.placeholder.com/80?text=Ø¶ÙŠÙ";
        usernameEl.textContent = "Ø¶ÙŠÙ";
      }
    }

    function loadAdditionalIcons() {
      const iconCategories = [
        { title: "Ø§Ù„ØªØ¹Ù„ÙŠÙ…", icons: ["graduation-cap", "book", "pencil-alt"] },
        { title: "Ø§Ù„ØªÙ‚Ù†ÙŠØ©", icons: ["laptop-code", "microchip", "server"] },
        { title: "Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨", icons: ["gamepad", "dice", "chess"] },
        { title: "Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©", icons: ["users", "comments", "thumbs-up"] },
        { title: "Ø§Ù„ØªØ³ÙˆÙ‚", icons: ["shopping-cart", "tags", "store"] }
      ];
      
      const iconsContainer = document.createElement('div');
      iconsContainer.className = 'card';
      iconsContainer.innerHTML = `
        <div class="section-title"><i class="fas fa-icons"></i> Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ³Ø¹Ø©</div>
        ${iconCategories.map(cat => `
          <div style="margin: 16px 0 8px 0; font-weight: 500">
            <i class="fas fa-folder"></i> ${cat.title}
          </div>
          <div class="row" style="gap: 8px; margin-bottom: 12px;">
            ${cat.icons.map(icon => `
              <button class="btn" style="flex: none; padding: 8px 12px">
                <i class="fas fa-${icon}"></i>
              </button>
            `).join('')}
          </div>
        `).join('')}
      `;
      
      $('#view-settings .container').appendChild(iconsContainer);
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Firebase Storage
    async function uploadAvatar(file, userId) {
      return new Promise((resolve, reject) => {
        const storageRef = firebase.storage().ref();
        const fileExtension = file.name.split('.').pop();
        const avatarRef = storageRef.child(`avatars/${userId}/profile.${fileExtension}`);
        
        const uploadTask = avatarRef.put(file);
        
        uploadTask.on('state_changed',
          (snapshot) => {
            // ØªØªØ¨Ø¹ ØªÙ‚Ø¯Ù… Ø§Ù„Ø±ÙØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            console.log('Upload is ' + progress + '% done');
          },
          (error) => {
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            reject(error);
          },
          () => {
            // Ø§Ù„Ø±ÙØ¹ Ø§ÙƒØªÙ…Ù„ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©
            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
              resolve(downloadURL);
            });
          }
        );
      });
    }

    // Chat Functions
    async function handleChatSubmit(e) {
      e.preventDefault();
      const text = $('#user-input').value.trim();
      if (!text) return;

      // Display user message
      displayMessage(text, 'user');
      $('#user-input').value = '';
      
      // Show typing indicator
      const typing = showTyping();
      const btn = $('#chat-form button');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

      try {
        // Send to selected API
        const apiUrl = API_MODELS[state.selectedModel] + encodeURIComponent(text);
        const response = await fetch(apiUrl, {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.text();
        
        // Display bot response
        displayMessage(data, 'bot');
        
      } catch (error) {
        console.error('API Error:', error);
        const errorMsg = error.message.includes('Failed to fetch') 
          ? "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"
          : "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ";
        displayMessage(errorMsg, 'bot');
      } finally {
        typing.remove();
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
      }
    }

    function displayMessage(text, sender) {
      const msg = document.createElement('div');
      msg.className = `message ${sender}`;
      msg.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
      $('#chat-content').appendChild(msg);
      $('#chat-content').scrollTop = $('#chat-content').scrollHeight;
    }

    function showTyping() {
      const wrap = document.createElement('div');
      wrap.className = 'message bot';
      wrap.innerHTML = `
        <div class="typing">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
      `;
      $('#chat-content').appendChild(wrap);
      $('#chat-content').scrollTop = $('#chat-content').scrollHeight;
      return wrap;
    }

    // Projects Functions
    function createProject() {
      const name = $('#proj-name').value.trim();
      const desc = $('#proj-desc').value.trim();
      const tags = $('#proj-tags').value.split(',').map(s => s.trim()).filter(Boolean);
      
      if (!name) { 
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹'); 
        return; 
      }

      const newProject = { 
        name, 
        desc, 
        tags, 
        createdAt: Date.now(),
        id: 'proj-' + Math.random().toString(36).substr(2, 9)
      };
      
      state.projects.push(newProject);
      saveProjects();
      
      // Update stats
      updateStats();
      
      // Render with animation
      renderProjects(); 
      clearProjectForm();
      
      // Animation effect
      const cards = $$('.project-card');
      const lastCard = cards[cards.length - 1];
      lastCard.style.animation = 'fadeIn 0.5s ease-out';
      
      // Button effect
      const btn = $('#btn-create');
      btn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡!';
      setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡';
      }, 2000);
    }

    function updateStats() {
      const projectsCount = $('#view-settings .card:nth-child(1) .card:first-child div:first-child');
      const progressFill = $('.progress-fill');
      
      if (projectsCount) projectsCount.textContent = state.projects.length;
      if (progressFill) progressFill.style.width = `${Math.min(state.projects.length * 10, 100)}%`;
    }

    function clearProjectForm() {
      $('#proj-name').value = ''; 
      $('#proj-desc').value = ''; 
      $('#proj-tags').value = '';
      
      // Add shake animation to clear button
      const btn = $('#btn-clear-form');
      btn.classList.add('btn-shake');
      setTimeout(() => btn.classList.remove('btn-shake'), 500);
    }

    function renderProjects() {
      const root = $('#projects-list');
      root.innerHTML = '';
      
      if (!state.projects.length) {
        root.innerHTML = `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø¹Ø¯. Ø£Ø¶Ù Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø£ÙˆÙ„ ğŸ‘‡</div>`;
        return;
      }

      state.projects.forEach((p, idx) => {
        const card = document.createElement('div');
        card.className = 'card project-card';
        card.innerHTML = `
          <div class="section-title" style="margin:0 0 8px 0"><i class="fas fa-folder"></i> ${escapeHtml(p.name)}</div>
          <div class="muted" style="margin-bottom:8px">${escapeHtml(p.desc || '')}</div>
          <div>${(p.tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>
          <div class="space"></div>
          <div class="row">
            <button class="btn" data-act="open" data-idx="${idx}"><i class="fas fa-play"></i> ÙØªØ­</button>
            <button class="btn secondary" data-act="edit" data-idx="${idx}"><i class="fas fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn danger" data-act="delete" data-idx="${idx}"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
          </div>
        `;
        root.appendChild(card);
      });
    }

    function handleProjectActions(e) {
      const btn = e.target.closest('button[data-act]'); 
      if (!btn) return;
      
      const idx = +btn.dataset.idx; 
      const act = btn.dataset.act;
      
      if (Number.isNaN(idx) || !state.projects[idx]) return;
      
      const project = state.projects[idx];
      
      switch (act) {
        case 'delete':
          if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ')) {
            state.projects.splice(idx, 1); 
            saveProjects(); 
            renderProjects();
            updateStats();
          }
          break;
          
        case 'open':
          alert('ØªÙ… ÙØªØ­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ' + project.name);
          break;
          
        case 'edit':
          const name = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…', project.name) ?? project.name;
          const desc = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØµÙ', project.desc) ?? project.desc;
          const tags = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ³ÙˆÙ… (Ø§ÙØµÙ„Ù‡Ø§ Ø¨ÙÙˆØ§ØµÙ„)', (project.tags || []).join(', '));
          
          project.name = name.trim() || project.name;
          project.desc = (desc || '').trim();
          project.tags = (tags || '').split(',').map(s => s.trim()).filter(Boolean);
          
          saveProjects(); 
          renderProjects();
          break;
      }
    }

    function clearAllProjects() {
      if (!state.projects.length) return;
      if (confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹!')) { 
        state.projects = []; 
        saveProjects(); 
        renderProjects(); 
        updateStats();
      }
    }

    // Settings Functions
    function toggleDarkMode(e) {
      state.settings.dark = e.target.checked;
      applySettingsToDOM();
      saveSettings();
    }

    function changeLanguage(e) {
      state.settings.lang = e.target.value;
      applySettingsToDOM();
      saveSettings();
    }

    function changeFontSize(e) {
      state.settings.fontSize = e.target.value;
      applySettingsToDOM();
      saveSettings();
    }

    function changePrimaryColor(color) {
      state.settings.primary = color;
      applySettingsToDOM();
      saveSettings();
      
      // Add animation to selected color dot
      $$('.color-dot').forEach(dot => {
        dot.style.transform = dot.dataset.color === color ? 'scale(1.2)' : 'scale(1)';
      });
    }

    function resetSettings() {
      if (confirm('Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ')) {
        state.settings = { dark: false, primary: '#2563eb', lang: 'ar', fontSize: '16px' };
        applySettingsToDOM(); 
        saveSettings();
      }
    }

    function resetUsers() {
      if (confirm('Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ!')) {
        logout();
      }
    }

    // Auth Functions
    async function register() {
      const name = $('#reg-name').value.trim();
      const username = $('#reg-username').value.trim();
      const email = $('#reg-email').value.trim().toLowerCase();
      const pass = $('#reg-pass').value.trim();
      const avatarFile = $('#reg-avatar').files[0];
      
      if (!name || !username || !email || !pass) { 
        alert('Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'); 
        return; 
      }
      
      const btn = $('#btn-register');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';
      
      try {
        const { user } = await auth.createUserWithEmailAndPassword(email, pass);
        
        let avatarURL = '';
        if (avatarFile) {
          try {
            avatarURL = await uploadAvatar(avatarFile, user.uid);
          } catch (error) {
            console.error('Error uploading avatar:', error);
            // Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
            avatarURL = '';
          }
        }
        
        await db.collection('users').doc(user.uid).set({
          name,
          username,
          email,
          avatar: avatarURL,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        state.currentUser = {
          uid: user.uid,
          name,
          username,
          email,
          avatar: avatarURL
        };
        
        saveCurrentUser();
        refreshAuthUI();
        
        // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        $('#reg-name').value = '';
        $('#reg-username').value = '';
        $('#reg-email').value = '';
        $('#reg-pass').value = '';
        $('#reg-avatar').value = '';
        $('#avatar-preview').innerHTML = '';
        
        // Success animation
        btn.innerHTML = '<i class="fas fa-check"></i> ØªÙ…!';
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-user-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
          btn.disabled = false;
        }, 1500);
        
        alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
        switchView('chat');
      } catch (error) {
        console.error('Registration error:', error);
        btn.innerHTML = '<i class="fas fa-user-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
        btn.disabled = false;
        
        alert(error.message.includes('email-already-in-use') 
          ? 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„' 
          : 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + error.message);
      }
    }

    async function login() {
      const email = $('#log-email').value.trim().toLowerCase();
      const pass = $('#log-pass').value.trim();
      
      const btn = $('#btn-login');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
      
      try {
        const { user } = await auth.signInWithEmailAndPassword(email, pass);
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        state.currentUser = {
          uid: user.uid,
          name: userDoc.data().name,
          username: userDoc.data().username,
          email: user.email,
          avatar: userDoc.data().avatar || ''
        };
        
        saveCurrentUser();
        refreshAuthUI();
        
        $('#log-email').value = '';
        $('#log-pass').value = '';
        
        // Success animation
        btn.innerHTML = '<i class="fas fa-check"></i> ØªÙ…!';
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„';
          btn.disabled = false;
        }, 1500);
        
        alert('Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + state.currentUser.name + ' ğŸ‘‹');
        switchView('chat');
      } catch (error) {
        console.error('Login error:', error);
        btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„';
        btn.disabled = false;
        
        alert(error.message.includes('wrong-password') 
          ? 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©' 
          : error.message.includes('user-not-found') 
            ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯' 
            : 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
      }
    }

    async function logout() {
      if (!state.currentUser) return;
      if (confirm('ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        try {
          await auth.signOut();
          state.currentUser = null; 
          saveCurrentUser();
          refreshAuthUI();
          alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.');
        } catch (error) {
          console.error('Logout error:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
        }
      }
    }

    function refreshAuthUI() {
      const info = $('#account-info');
      const logoutBtn = $('#btn-logout');
      const pill = $('#user-pill');
      const namePill = $('#user-name-pill');

      if (state.currentUser) {
        info.textContent = 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„: ' + state.currentUser.name + ' (' + state.currentUser.email + ')';
        logoutBtn.classList.remove('hidden');
        pill.style.display = 'flex';
        namePill.textContent = state.currentUser.name;
        
        // Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (state.currentUser.avatar) {
          const avatarImg = document.createElement('img');
          avatarImg.src = state.currentUser.avatar;
          avatarImg.alt = "ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„";
          
          // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ØµÙˆØ±Ø© Ø³Ø§Ø¨Ù‚Ø©
          const existingImg = pill.querySelector('img');
          if (existingImg) {
            existingImg.remove();
          }
          
          pill.insertBefore(avatarImg, pill.firstChild);
        }
      } else {
        info.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„';
        logoutBtn.classList.add('hidden');
        pill.style.display = 'none';
        namePill.textContent = '';
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
      updateSidebarProfile();
      applySettingsToDOM();
    }

    // Utility Functions
    function switchView(view) {
      $$('.view').forEach(v => v.classList.remove('active'));
      $('#view-' + view).classList.add('active');
    }

    function applySettingsToDOM() {
      // Theme
      body.classList.toggle('dark', state.settings.dark);
      document.documentElement.style.setProperty('--primary', state.settings.primary);
      document.documentElement.style.setProperty('--fs', state.settings.fontSize);

      // Language
      const isAR = state.settings.lang === 'ar';
      document.documentElement.setAttribute('dir', isAR ? 'rtl' : 'ltr');
      document.documentElement.setAttribute('lang', isAR ? 'ar' : 'en');

      // Controls
      $('#set-dark').checked = state.settings.dark;
      $('#set-lang').value = state.settings.lang;
      $('#set-font').value = state.settings.fontSize;

      // Ø¥Ø²Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø¹Ù„Ùˆ
      $('#user-input').placeholder = isAR ? 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...' : 'Type your message...';

      // Theme icon
      $('#theme-btn').innerHTML = state.settings.dark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    }
    
    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, m => 
        ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
    }

    // Storage Functions
    function saveSettings() {
      localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(state.settings));
    }

    function saveProjects() {
      localStorage.setItem(STORAGE_PROJECTS, JSON.stringify(state.projects));
    }

    function saveCurrentUser() {
      state.currentUser
        ? localStorage.setItem(STORAGE_CURRENT_USER, JSON.stringify(state.currentUser))
        : localStorage.removeItem(STORAGE_CURRENT_USER);
    }
  
  </script>
</body>
</html>
